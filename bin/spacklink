#!/bin/sh

#------------------------------------------------------------
# spacklink:
#
#  a script to set up links in etc/spack in a specified 
#  <spack directory> to configuration files for a <site> 
#  and a <machine>
#------------------------------------------------------------

#------------------------------------------------------------
# usage message
#------------------------------------------------------------

usage()
{
	    cat <<EOF 1>&2

Usage:
  spacklink [-n] <spack directory> <site> <machine name>
EOF
    exit 1
}


#------------------------------------------------------------
# the script
#------------------------------------------------------------

spack_config_root_relative=`dirname $0`/..
spack_config_root=`realpath $spack_config_root_relative`

if [ "$1" == "-n" ]; then
	echo=echo
	shift
else
	echo=
fi

# $1 spack directory
if [ "$1" == "" ]; then
	usage
else
	spack_root=$1

fi

# $2 site 
if [ "$2" == "" ]; then
	usage
else
	site=$2
fi

# $3 machine 
if [ "$3" == "" ]; then
	usage
else
	machine=$3
fi

#check for valid spack root 
if test ! -d $spack_root/etc/spack; then
	echo "spacklink: Invalid spack directory $spack_root"
	usage
fi

#check for valid site
if test ! -d $spack_config_root/$site; then
	echo "spacklink: Invalid site directory $spack_config_root/$site"
	usage
fi

#check for valid machine
if test ! -d $spack_config_root/$site/$machine; then
	echo "spacklink: Invalid machine directory $spack_config_root/$site/$machine"
	usage
fi

spack_etc=$spack_root/etc/spack
spack_machcfg_root="$(realpath -m $spack_root/../cfg/$machine.system)"
spack_env_root="$(realpath -m $spack_root/../envs)"
spack_env_yaml="$spack_env_root/hpctoolkit/spack.yaml"

echo Removing current spack configuration settings
$echo /bin/rm -rf $spack_etc/*.yaml

echo "Configuring $spack_root with spack configuration files for  site=$site machine=$machine"

site_config=$spack_config_root/$site/$site.config.yaml
site_modules=$spack_config_root/$site/$site.modules.yaml
site_packages=$spack_config_root/$site/$site.packages.yaml
config=$spack_config_root/$site/$machine/$machine.config.yaml
modules=$spack_config_root/$site/$machine/$machine.modules.yaml
packages=$spack_config_root/$site/$machine/$machine.packages.yaml
compilers=$spack_config_root/$site/$machine/$machine.compilers.yaml
spack_env_yaml=$spack_config_root/$site/$machine/$machine.spack.yaml

if test ! -f $site_config; then
  echo "No site-wide config file ${site_config}; skipping"
else
  $echo ln -s $site_config $spack_etc/config.yaml
fi

if test ! -f $site_modules; then
  echo "No site-wide modules file ${site_modules}; skipping"
else
  $echo ln -s $site_modules $spack_etc/modules.yaml
fi

if test ! -f $site_packages; then
  echo "No site-wide packages file ${site_packages}; skipping"
else
  $echo ln -s $site_packages $spack_etc/packages.yaml
fi

if test ! -f $config; then
  echo "No machine-specific config file $config; skipping"
else
  if test ! -d "$spack_machcfg_root"; then
    echo "Creating Spack machine-specific config directory at $spack_machcfg_root"
    $echo mkdir -p "$spack_machcfg_root"
  fi
  $echo ln -s $config $spack_machcfg_root/config.yaml
fi

if test ! -f $modules; then
  echo "No machine-specific modules file $modules; skipping"
else
  if test ! -d "$spack_machcfg_root"; then
    echo "Creating Spack machine-specific config directory at $spack_machcfg_root"
    $echo mkdir -p "$spack_machcfg_root"
  fi
  $echo ln -s $modules $spack_machcfg_root/modules.yaml
fi

if test ! -f $packages; then
  echo "No machine-specific packages file $packages; skipping"
else
  if test ! -d "$spack_machcfg_root"; then
    echo "Creating Spack machine-specific config directory at $spack_machcfg_root"
    $echo mkdir -p "$spack_machcfg_root"
  fi
  $echo ln -s $packages $spack_machcfg_root/packages.yaml
fi

if test ! -f $compilers; then
  echo "No machine-specific compilers file $compilers; skipping"
else
  if test ! -d "$spack_machcfg_root"; then
    echo "Creating Spack machine-specific config directory at $spack_machcfg_root"
    $echo mkdir -p "$spack_machcfg_root"
  fi
  $echo ln -s $compilers $spack_machcfg_root/compilers.yaml
fi

if ! test -f $spack_env_yaml; then
  echo "No environment file ${spack_env_yaml}; skipping" 
else
  if test ! -d "$spack_env_root/hpctoolkit"; then
    echo "Creating Spack environment directory at $spack_env_root/hpctoolkit"
    $echo mkdir -p "$spack_env_root/hpctoolkit-$machine"
  fi
  echo "Linking Spack environment yaml file"
  $echo ln -s $spack_env_yaml $spack_env_root/hpctoolkit-$machine/spack.yaml
  echo "Linking Spack environments directory"
  $echo ln -s $spack_env_root $spack_root/var/spack/environments
fi
