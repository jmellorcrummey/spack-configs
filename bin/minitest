#!/bin/sh

#------------------------------------------------------------
# minitest:
#
#  a script iterate over subdirectories, and run a make command on each
#------------------------------------------------------------

#------------------------------------------------------------
# usage message
#------------------------------------------------------------

usage()
{
	    cat <<EOF 1>&2

Usage:
  minitest <makecmd>
	Only "ll", "clean", "clobber", and "hpct" are supported
	Be sure to correctly set TOPDIR to the top-level directory
EOF
    exit 1
}


#------------------------------------------------------------
# the script
#------------------------------------------------------------
source miniconfig

echo "TOPDIR = $TOPDIR"
echo ""

# echo -n "CPUDIRS: "
# for sd in "${CPUDIRS[@]}"
# do
# 	echo -n " $sd"
# done
# echo ""

# echo -n "NVIDIADIRS: "
# for sd in "${NVIDIADIRS[@]}"
# do
# 	echo -n " $sd"
# done
# echo ""

# echo -n "ROCMDIRS: "
# for sd in "${ROCMDIRS[@]}"
# do
# 	echo -n " $sd"
# done
# echo ""

# echo -n "RUNDIRS: "
# for sd in "${RUNDIRS[@]}"
# do
# 	echo -n " $sd"
# done
# echo ""
# exit 0

go="f"

if [ "$1" == "ll" ]; then
	go="ll"
fi

if [ "$1" == "clean" ]; then
	go="t"
fi

if [ "$1" == "clobber" ]; then
	go="t"
fi

if [ "$1" == "hpct" ]; then
	go="t"
fi

if [ "$go" == "f" ]; then
	usage
fi

echo ""
date
pwd
hpcrun -V
echo " - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -"
echo ""
for sd in "${RUNDIRS[@]}"
do
	echo ""
	echo "================================================================="
	echo ""
	if [ "${go}" == "ll" ]; then
		echo "cd'ing to ${sd} to run \"ls -alF\""
		(cd ${TOPDIR}/${sd} ; ls -alF )
	else
		echo "cd'ing to ${sd} to run \"make $1\""
		(cd ${TOPDIR}/${sd} ; make $1)
	fi
done
echo ""
echo " - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -"
echo ""
echo ""
exit 0
exit 0
