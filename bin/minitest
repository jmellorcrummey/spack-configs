#!/bin/sh

#------------------------------------------------------------
# minitest:
#
#  a script iterate over subdirectories, and run a make command on each
#------------------------------------------------------------

#------------------------------------------------------------
# usage message
#------------------------------------------------------------

usage()
{
	    cat <<EOF
minitest is a shell script that will process a set of subdirectories
inside a TEST repository.  It requires that it be invoked with two
definitions
    TOPDIR, pointing to the top of the repository; and
    RUNDIRS, a list of the subdirectories to be processed.

    Both of these are obtained by sourcing a file named
    file named "miniconfig" in the same directory as this.

    An "example.miniconfig" file is in this directory, and should
    be used as a template for customizing the test run.

Usage:
  minitest <makecmd>
	Only <makecmd>'s of "ll", "clean", "clobber", and "hpct" are supported

EOF
    exit 1
}


#------------------------------------------------------------
# the script
#------------------------------------------------------------
source miniconfig

if [ "${TOPDIR}" == "" ]; then
	echo "TOPDIR is not set."
	usage
fi
if [ "${RUNDIRS}" == "" ]; then
	echo "RUNDIRS is not set."
	usage
fi
echo ""

# echo "TOPDIR: "
# echo -n "RUNDIRS: "
# for sd in "${RUNDIRS[@]}"
# do
# 	echo -n " $sd"
# done
# echo ""

go="f"

if [ "$1" == "ll" ]; then
	go="ll"
fi

if [ "$1" == "clean" ]; then
	go="t"
fi

if [ "$1" == "clobber" ]; then
	go="t"
fi

if [ "$1" == "hpct" ]; then
	go="t"
fi

if [ "$go" == "f" ]; then
	usage
fi

# remove any previous log of a run
/bin/rm -f log.minitest

# create a new log, with information about the system
echo " - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -" 2>&1 | tee -a log.minitest
echo -n "minitest $1 -- invoked on " 2>&1 | tee -a log.minitest
date 2>&1 | tee -a log.minitest
pwd 2>&1 | tee -a log.minitest
echo "" 2>&1 | tee -a log.minitest
hpcrun -V 2>&1 | tee -a log.minitest
echo "" 2>&1 | tee -a log.minitest
clang --version 2>&1 | tee -a log.minitest
gcc --version 2>&1 | tee -a log.minitest

for sd in "${RUNDIRS[@]}"
do
	echo "" 2>&1 | tee -a log.minitest
		echo "================================================================="  2>&1 | tee -a log.minitest
	if [ "${go}" == "ll" ]; then
		echo "cd'ing to ${sd} to run \"ls -alF\""  2>&1 | tee -a log.minitest
		(cd ${TOPDIR}/${sd} ; ls -alF )  2>&1 | tee -a log.minitest
	else
		echo "cd'ing to ${sd} to run \"make $1\""  2>&1 | tee -a log.minitest
		(cd ${TOPDIR}/${sd} ; make $1)  2>&1 | tee -a log.minitest
	fi
done
echo " - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -"  2>&1 | tee -a log.minitest
echo ""  2>&1 | tee -a log.minitest
exit 0
